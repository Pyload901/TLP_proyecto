# Integration Testing and Codebase Changes

This document outlines the integration testing framework established for the project and the critical changes made to the language translator to ensure correct execution of bytecode on the VM.

## 1. Integration Testing Framework

To verify that the programming language compiler (parser/translator) and the Virtual Machine (VM) work together correctly, an automated integration test suite was created.

### Components

*   **`integration_tests.py`**: A Python script that orchestrates the testing process.
    *   **Builds Tools**: Automatically runs `make` in `language/` and `vm/test/` to ensure the compiler and VM runner are up-to-date.
    *   **Compiles Source**: Takes a snippet of source code, writes it to `language/test.src`, and runs the `language/parser` to generate `program.vmcode`.
    *   **Runs VM**: Executes the generated bytecode using the `vm_runner`.
    *   **Verifies Output**: Parses the final register state printed by the VM and compares it against expected values.

*   **`vm/test/vm_runner.cpp`**: A C++ wrapper for the Arduino-based VM (`vm_complete.ino`).
    *   It allows the VM code to be compiled and run on a standard Linux environment for testing purposes.
    *   It loads a binary bytecode file into memory and executes it using the `TinyVM` class.
    *   It prints the final state of the registers (R0-R7) to stdout for verification.

*   **`vm/test/Makefile`**: Updated to include a target for building the `vm_runner` executable.

### Test Cases

The suite currently includes the following tests:

1.  **Simple Assignment**: Verifies that a variable can be declared and assigned a literal value.
2.  **Addition**: Verifies variable declaration and arithmetic operations (`+`).
3.  **Loop**: Verifies control flow (`for` loop) and variable updates within a loop body.

## 2. Changes to `language/translator.c`

Several modifications were made to the translator to fix bugs and support the VM's requirements.

### Binary Bytecode Output
*   **Previous Behavior**: The translator generated a text-based assembly listing (e.g., `0000 LOADI 0 10`).
*   **New Behavior**: The translator now writes **raw binary bytes** to `program.vmcode`. This is necessary because the VM expects a binary stream of opcodes and arguments, not text.

### Register Allocator Fix
*   **The Issue**: The original register allocator used a simple stack-based approach (`temp_top`). This caused a critical bug in complex expressions (like loop conditions) where a temporary register holding a value was "freed" and reused prematurely, overwriting data needed for subsequent instructions.
*   **The Fix**: Implemented a **bitmap-based register allocator**.
    *   Added `used_regs_mask` to the `Translator` struct.
    *   `alloc_temp()` now searches for the highest available register bit in the mask.
    *   `release_temp()` clears the specific bit in the mask.
    *   This ensures that registers are only reused when they are explicitly released, preventing data corruption in loops and complex logic.

## How to Run Tests

To run the integration tests, execute the following command from the project root:

```bash
python3 integration_tests.py
```

Expected output:
```text
Building compiler...
Building VM runner...
Running test: Simple Assignment
PASS: Simple Assignment
Running test: Addition
PASS: Addition
Running test: Loop
PASS: Loop

Summary: 3/3 tests passed.
```
